# tBTC v2 Account Control V1.1 Deployment Guide

**Version**: 1.1  
**Date**: 2025-07-15  
**Purpose**: Comprehensive deployment guide for V1.1 Watchdog Quorum System  

---

## Overview

This guide covers the deployment of the V1.1 Account Control system with the optimistic N-of-M watchdog quorum. The V1.1 system provides significant improvements over V1.0 including:

- **Optimistic Execution**: MEV-resistant primary validator selection
- **Byzantine Fault Tolerance**: Tolerates up to (N-1)/3 Byzantine failures
- **Escalating Consensus**: Progressive delays based on dispute levels
- **Backward Compatibility**: Maintains SingleWatchdog interface
- **Security Enhancements**: Reentrancy protection and comprehensive validation

## Deployment Order

### Phase 1: Core Infrastructure (Scripts 95-97)
```bash
# Deploy Account Control core components
npx hardhat deploy --tags AccountControlCore
npx hardhat deploy --tags AccountControlState  
npx hardhat deploy --tags AccountControlPolicies
```

### Phase 2: V1.1 Watchdog Quorum (Script 98)
```bash
# Deploy V1.1 Watchdog Quorum System
npx hardhat deploy --tags AccountControlWatchdog
```

**Deployed Contracts:**
- `OptimisticWatchdogConsensus`: Core consensus mechanism
- `WatchdogAdapter`: Backward compatibility layer

### Phase 3: System Configuration (Script 99)
```bash
# Configure complete system
npx hardhat deploy --tags AccountControlConfig
```

**Configuration Steps:**
1. Register all services in ProtocolRegistry
2. Set up access control roles
3. Configure consensus system roles
4. Set up initial watchdog set
5. Verify system operational status

### Phase 4: Operator Configuration (Script 100)
```bash
# Configure watchdog operators
npx hardhat deploy --tags WatchdogOperators
```

**Operator Setup:**
1. Grant WATCHDOG_OPERATOR_ROLE to authorized operators
2. Setup watchdog roles in system contracts
3. Verify operator configuration

## Key Components

### OptimisticWatchdogConsensus.sol
- **Purpose**: Core N-of-M consensus mechanism
- **Key Features**:
  - MEV-resistant validator selection using blockhash
  - Escalating delays (1h→4h→12h→24h)
  - Approval mechanism for disputed operations
  - Emergency override capabilities

### WatchdogAdapter.sol
- **Purpose**: Backward compatibility with SingleWatchdog interface
- **Key Features**:
  - Dual execution paths (consensus vs. direct)
  - Event compatibility for monitoring
  - Role-based access control
  - Operation encoding/decoding

## Security Considerations

### Access Control Roles

**OptimisticWatchdogConsensus:**
- `DEFAULT_ADMIN_ROLE`: Full system administration
- `EMERGENCY_ROLE`: Emergency override capabilities
- `MANAGER_ROLE`: Watchdog set management
- Active watchdogs: Can submit operations and challenges

**WatchdogAdapter:**
- `DEFAULT_ADMIN_ROLE`: Contract administration
- `WATCHDOG_OPERATOR_ROLE`: Can submit operations

### Initial Setup Security

1. **Test Configuration**: Initial deployment includes test addresses
2. **Production Update**: Replace with production watchdog addresses
3. **Governance Transfer**: Transfer admin roles to governance multisig
4. **Role Verification**: Verify all roles are properly configured

## Production Deployment Checklist

### Pre-Deployment
- [ ] Verify all contracts compile successfully
- [ ] Run comprehensive test suite
- [ ] Audit contract code for security vulnerabilities
- [ ] Prepare production watchdog addresses
- [ ] Set up governance multisig

### Deployment
- [ ] Deploy core infrastructure (scripts 95-97)
- [ ] Deploy V1.1 watchdog quorum (script 98)
- [ ] Configure system (script 99)
- [ ] Set up operators (script 100)
- [ ] Verify all deployments

### Post-Deployment
- [ ] Replace test addresses with production addresses
- [ ] Transfer admin roles to governance
- [ ] Test reserve attestation operations
- [ ] Test redemption operations
- [ ] Test challenge mechanisms
- [ ] Set up monitoring and alerts

## Configuration Parameters

### Consensus Parameters
- **Base Challenge Period**: 1 hour (3600 seconds)
- **Escalation Delays**: [1h, 4h, 12h, 24h]
- **Consensus Thresholds**: [0, 2, 3, 5] objections
- **Minimum Watchdogs**: 3
- **Maximum Watchdogs**: 20

### Security Parameters
- **Reentrancy Protection**: Enabled on all execution functions
- **MEV Resistance**: Blockhash-based validator selection
- **Byzantine Tolerance**: Up to (N-1)/3 failures
- **Emergency Override**: Governance-controlled

## Monitoring and Operations

### Key Events to Monitor
- `OperationSubmitted`: New operations submitted
- `OperationChallenged`: Operations challenged by watchdogs
- `OperationExecuted`: Operations executed successfully
- `ConsensusEscalated`: Consensus escalated due to disputes
- `EmergencyOverride`: Emergency actions taken

### Operational Procedures
1. **Normal Operations**: Primary validator submits, others monitor
2. **Challenge Response**: Watchdogs challenge suspicious operations
3. **Dispute Resolution**: Approval mechanism for highly disputed operations
4. **Emergency Response**: Governance can override in extreme cases

## Testing

### Unit Tests
- **OptimisticWatchdogConsensus.test.ts**: Core consensus functionality
- **SecurityTests.test.ts**: Security vulnerability tests
- **WatchdogAdapter.test.ts**: Compatibility layer tests

### Integration Tests
- End-to-end operation flows
- Cross-contract interactions
- Role-based access control
- Emergency scenarios

## Troubleshooting

### Common Issues
1. **Role Configuration**: Verify all roles are properly granted
2. **Service Registration**: Check ProtocolRegistry service mappings
3. **Watchdog Setup**: Ensure minimum 3 watchdogs are added
4. **Operator Access**: Verify WATCHDOG_OPERATOR_ROLE assignments

### Verification Commands
```bash
# Check consensus state
npx hardhat console --network <network>
> const consensus = await ethers.getContract("OptimisticWatchdogConsensus")
> await consensus.getConsensusState()

# Check active watchdogs
> await consensus.getActiveWatchdogs()

# Check adapter operational status
> const adapter = await ethers.getContract("WatchdogAdapter")
> await adapter.isWatchdogOperational()
```

## Support

For deployment issues or questions:
1. Check deployment logs for error messages
2. Verify contract addresses and configurations
3. Review test results for any failures
4. Consult security audit reports
5. Contact development team for assistance

---

**⚠️ IMPORTANT**: This deployment guide is for the V1.1 system. Ensure all team members understand the new consensus mechanism before production deployment.