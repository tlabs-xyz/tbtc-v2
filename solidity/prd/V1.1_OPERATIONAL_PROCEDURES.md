# tBTC v2 Account Control V1.1 Operational Procedures

**Document Version**: 1.0  
**Date**: 2025-07-15  
**Architecture**: Optimistic N-of-M Watchdog Quorum  
**Status**: V1.1 Implementation Guide  
**Related Documents**: [ARCHITECTURE.md](ARCHITECTURE.md), [REQUIREMENTS.md](REQUIREMENTS.md), [watchdog-decentralization.md](watchdog-decentralization.md)

---

## Table of Contents

1. [Overview](#1-overview)
2. [System Architecture](#2-system-architecture)
3. [Watchdog Roles and Responsibilities](#3-watchdog-roles-and-responsibilities)
4. [Operational Workflows](#4-operational-workflows)
5. [Challenge and Dispute Resolution](#5-challenge-and-dispute-resolution)
6. [Emergency Procedures](#6-emergency-procedures)
7. [Monitoring and Alerting](#7-monitoring-and-alerting)
8. [Maintenance Operations](#8-maintenance-operations)
9. [Security Procedures](#9-security-procedures)
10. [Troubleshooting Guide](#10-troubleshooting-guide)

---

## 1. Overview

### 1.1 System Introduction

The V1.1 tBTC Account Control system implements an **Optimistic N-of-M Watchdog Quorum** that provides:

- **Decentralized Consensus**: Multiple watchdogs participate in validation decisions
- **Optimistic Execution**: Operations execute efficiently with challenge periods
- **Byzantine Fault Tolerance**: System remains operational with up to (N-1)/3 Byzantine failures
- **Escalating Security**: Progressive delays and consensus requirements based on dispute levels
- **Emergency Capabilities**: Governance can override in extreme scenarios

### 1.2 Key Components

- **OptimisticWatchdogConsensus**: Core consensus mechanism
- **WatchdogAdapter**: Backward compatibility interface
- **Primary Validators**: Selected validators for each operation
- **Challenge System**: Mechanism for disputing operations
- **Approval System**: Explicit approval for highly disputed operations

### 1.3 Security Model

The system operates on a **trust-but-verify** model:
1. **Primary validators** submit operations optimistically
2. **Other watchdogs** monitor and can challenge suspicious operations
3. **Challenge periods** allow time for dispute resolution
4. **Escalating consensus** ensures disputed operations receive proper review
5. **Emergency override** provides governance escape hatch

---

## 2. System Architecture

### 2.1 Consensus Flow

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Operation     │    │   Challenge     │    │   Execution     │
│   Submission    │────│   Period        │────│   or Dispute   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         │                        │                        │
    ┌─────────┐            ┌─────────────┐         ┌─────────────┐
    │Primary  │            │Other        │         │Consensus    │
    │Validator│            │Watchdogs    │         │Mechanism    │
    │Selected │            │Monitor      │         │Determines   │
    │(MEV-    │            │& Challenge  │         │Execution    │
    │resistant)│            │if Needed    │         │or Approval  │
    └─────────┘            └─────────────┘         └─────────────┘
```

### 2.2 Escalation Levels

| Level | Objections | Delay | Consensus Required |
|-------|------------|-------|-------------------|
| 0     | 0-1        | 1h    | None (optimistic) |
| 1     | 2          | 4h    | None (optimistic) |
| 2     | 3-4        | 12h   | 3+ approvals      |
| 3     | 5+         | 24h   | Majority approval |

### 2.3 Operation Types

- **RESERVE_ATTESTATION**: QC reserve balance updates
- **WALLET_REGISTRATION**: New Bitcoin wallet registration
- **STATUS_CHANGE**: QC status modifications
- **REDEMPTION_FULFILLMENT**: Redemption completion records

---

## 3. Watchdog Roles and Responsibilities

### 3.1 Active Watchdogs

**Selection Criteria:**
- Must be added to the consensus system by governance
- Should have proven track record in Bitcoin/DeFi operations
- Must maintain 24/7 operational capability
- Should have proper security infrastructure

**Core Responsibilities:**
- Monitor all operations submitted by other watchdogs
- Challenge suspicious or invalid operations
- Approve disputed operations when appropriate
- Maintain operational security and availability

### 3.2 Primary Validator Selection

**MEV-Resistant Algorithm:**
```solidity
// Deterministic selection based on operation and block data
bytes32 blockHash = blockhash(block.number - 1);
if (blockHash == bytes32(0)) {
    blockHash = keccak256(abi.encode(block.timestamp, block.difficulty));
}

uint256 seed = uint256(keccak256(abi.encode(
    operationType,
    operationData,
    blockHash,
    address(this)
)));

uint256 index = seed % activeWatchdogCount;
```

**Primary Validator Duties:**
- Submit operations optimistically after validation
- Provide evidence for operation validity
- Respond to challenges with additional documentation
- Ensure operation meets all requirements

### 3.3 Challenge Validators

**Monitoring Responsibilities:**
- Continuously monitor submitted operations
- Validate operation parameters against requirements
- Check for operational anomalies or security issues
- Submit challenges with supporting evidence

**Challenge Criteria:**
- Invalid operation parameters
- Insufficient supporting evidence
- Suspicious timing or patterns
- Technical implementation errors

---

## 4. Operational Workflows

### 4.1 Reserve Attestation Workflow

**Step 1: Continuous Monitoring**
```
Watchdogs monitor QC Bitcoin addresses
├── Check for balance changes
├── Verify transaction confirmations
├── Calculate reserve requirements
└── Determine if attestation needed
```

**Step 2: Primary Validator Submission**
```
Primary validator (selected per operation):
1. Validate current reserve balance
2. Check against minted tBTC amounts
3. Prepare attestation data
4. Submit optimistic operation
```

**Step 3: Challenge Period**
```
Other watchdogs (1-24 hours):
├── Verify balance calculations
├── Check Bitcoin address ownership
├── Validate transaction proofs
└── Challenge if discrepancies found
```

**Step 4: Execution or Dispute**
```
If no challenges:
├── Execute after challenge period
└── Update QC reserve records

If challenged:
├── Extend challenge period
├── Require explicit approvals
└── Execute only with sufficient consensus
```

### 4.2 Wallet Registration Workflow

**Step 1: QC Intent Declaration**
```
QC signals intent to register new wallet:
├── Provides Bitcoin address
├── Requests challenge hash
├── Prepares control proof
└── Submits to watchdog system
```

**Step 2: Challenge Hash Generation**
```
Watchdog generates challenge:
├── Create unique challenge hash
├── Provide to QC off-chain
├── QC creates proof transaction
└── QC submits SPV proof
```

**Step 3: Primary Validator Submission**
```
Primary validator:
1. Verify SPV proof validity
2. Confirm wallet control
3. Check address format compliance
4. Submit registration operation
```

**Step 4: Consensus Validation**
```
Other watchdogs verify:
├── SPV proof authenticity
├── Challenge hash correctness
├── Wallet address validity
└── QC authorization
```

### 4.3 Status Change Workflow

**Step 1: Status Assessment**
```
Watchdog identifies status change need:
├── QC compliance issues
├── Operational problems
├── Security concerns
└── Regulatory requirements
```

**Step 2: Evidence Collection**
```
Collect supporting evidence:
├── Transaction records
├── Compliance documentation
├── Security assessments
└── Operational metrics
```

**Step 3: Consensus Submission**
```
Primary validator:
1. Prepare status change request
2. Include supporting evidence
3. Submit with appropriate reason
4. Notify other watchdogs
```

**Step 4: Review and Execution**
```
Other watchdogs review:
├── Verify evidence validity
├── Assess status change appropriateness
├── Challenge if disagreement
└── Approve if consensus reached
```

---

## 5. Challenge and Dispute Resolution

### 5.1 Challenge Submission

**Valid Challenge Reasons:**
- Incorrect balance calculations
- Invalid SPV proofs
- Unauthorized operations
- Technical implementation errors
- Suspicious timing patterns

**Challenge Process:**
```solidity
// Submit challenge with evidence
function challengeOperation(
    bytes32 operationId,
    bytes calldata evidence
) external onlyActiveWatchdog {
    // Challenge recorded with evidence
    // Objection count incremented
    // Finalization time extended
}
```

### 5.2 Escalation Process

**Level 1 Escalation (2 objections):**
- Delay increased to 4 hours
- Additional review time provided
- No explicit approval required

**Level 2 Escalation (3+ objections):**
- Delay increased to 12 hours
- Explicit approval mechanism activated
- Minimum 3 approvals required

**Level 3 Escalation (5+ objections):**
- Delay increased to 24 hours
- Majority approval required
- Enhanced scrutiny applied

### 5.3 Approval Mechanism

**Approval Process:**
```solidity
// Approve disputed operation
function approveOperation(bytes32 operationId) external onlyActiveWatchdog {
    // Verify operation is disputed
    // Verify challenge period expired
    // Record approval vote
    // Check if sufficient approvals reached
}
```

**Approval Calculations:**
- **3-4 objections**: Minimum 3 approvals or 40% of watchdogs
- **5+ objections**: Majority of active watchdogs required

### 5.4 Dispute Resolution Guidelines

**Resolution Principles:**
1. **Evidence-based**: Decisions based on verifiable evidence
2. **Proportional**: Response proportional to risk level
3. **Transparent**: All evidence and reasoning documented
4. **Timely**: Disputes resolved within escalation timeframes
5. **Consistent**: Similar cases handled similarly

---

## 6. Emergency Procedures

### 6.1 Emergency Override

**Trigger Conditions:**
- Critical security vulnerabilities discovered
- System deadlock preventing normal operations
- Urgent regulatory compliance requirements
- Severe operational failures

**Override Process:**
```solidity
// Emergency override by governance
function emergencyOverride(
    bytes32 operationId,
    bytes32 reason
) external onlyRole(EMERGENCY_ROLE) {
    // Immediately execute operation
    // Bypass normal consensus requirements
    // Emit emergency event
}
```

### 6.2 System Pause

**Pause Triggers:**
- Multiple simultaneous security issues
- Coordinated attack on watchdog network
- Critical infrastructure failures
- Regulatory enforcement actions

**Pause Procedure:**
```solidity
// Pause consensus system
function pause() external onlyRole(EMERGENCY_ROLE) {
    _pause();
    consensusState.emergencyPause = true;
}
```

### 6.3 Emergency Communications

**Communication Channels:**
- Emergency Discord channel
- Email alerts to all watchdogs
- Governance forum notifications
- Public status page updates

**Response Protocol:**
1. **Immediate**: Alert all watchdogs within 5 minutes
2. **Assessment**: Evaluate situation within 15 minutes
3. **Decision**: Determine response within 30 minutes
4. **Execution**: Implement response within 1 hour
5. **Communication**: Public update within 2 hours

### 6.4 Recovery Procedures

**System Recovery Steps:**
1. **Assess**: Evaluate system state and damage
2. **Secure**: Ensure no ongoing threats
3. **Repair**: Fix identified issues
4. **Test**: Verify system functionality
5. **Resume**: Unpause system with monitoring
6. **Review**: Conduct post-mortem analysis

---

## 7. Monitoring and Alerting

### 7.1 Key Metrics

**Consensus Metrics:**
- Operation submission rate
- Challenge frequency
- Escalation distribution
- Approval success rate
- Emergency override usage

**Performance Metrics:**
- Average consensus time
- Watchdog response time
- System availability
- Error rates
- Gas consumption

**Security Metrics:**
- Failed challenge attempts
- Suspicious operation patterns
- Watchdog behavior anomalies
- Access control violations

### 7.2 Alert Conditions

**High Priority Alerts:**
- Emergency override activated
- System paused
- Multiple simultaneous challenges
- Watchdog unavailability
- Consensus deadlock

**Medium Priority Alerts:**
- Escalation to Level 2 or 3
- Unusual operation patterns
- Performance degradation
- Configuration changes

**Low Priority Alerts:**
- Normal challenges
- Routine operations
- Status updates
- Maintenance notifications

### 7.3 Monitoring Tools

**Event Monitoring:**
```solidity
// Key events to monitor
event OperationSubmitted(bytes32 indexed operationId, ...);
event OperationChallenged(bytes32 indexed operationId, ...);
event ConsensusEscalated(bytes32 indexed operationId, ...);
event EmergencyOverride(bytes32 indexed operationId, ...);
```

**Dashboard Metrics:**
- Active watchdog count
- Current consensus state
- Pending operations
- Challenge statistics
- System health indicators

### 7.4 Log Analysis

**Log Categories:**
- Operation lifecycle events
- Challenge and dispute events
- System state changes
- Error and warning messages
- Performance metrics

**Analysis Patterns:**
- Unusual operation timing
- Repeated challenge patterns
- Watchdog behavior correlation
- System performance trends
- Security event patterns

---

## 8. Maintenance Operations

### 8.1 Watchdog Management

**Adding Watchdogs:**
```bash
# Add new watchdog to consensus system
npx hardhat console --network mainnet
> const consensus = await ethers.getContract("OptimisticWatchdogConsensus")
> await consensus.addWatchdog(newWatchdogAddress)
```

**Removing Watchdogs:**
```bash
# Remove watchdog (requires minimum count maintained)
> const reason = ethers.utils.formatBytes32String("Inactivity")
> await consensus.removeWatchdog(watchdogAddress, reason)
```

**Watchdog Requirements:**
- Minimum 3 active watchdogs
- Maximum 20 active watchdogs
- Proper role configurations
- Operational readiness

### 8.2 System Configuration

**Parameter Updates:**
```bash
# Update consensus parameters
> await consensus.updateConsensusParameters(
    newThreshold,      // New consensus threshold
    newChallengePeriod // New base challenge period
)
```

**Service Registry Updates:**
```bash
# Update service addresses
> const registry = await ethers.getContract("ProtocolRegistry")
> await registry.setService(serviceKey, newAddress)
```

### 8.3 Routine Maintenance

**Daily Tasks:**
- Check watchdog availability
- Review operation statistics
- Monitor system performance
- Validate configuration integrity

**Weekly Tasks:**
- Analyze challenge patterns
- Review security events
- Update monitoring dashboards
- Conduct performance analysis

**Monthly Tasks:**
- Comprehensive security review
- System optimization assessment
- Documentation updates
- Training and drill exercises

### 8.4 Backup and Recovery

**Backup Procedures:**
- Configuration snapshots
- Event log backups
- Monitoring data archives
- Documentation versions

**Recovery Testing:**
- Disaster recovery drills
- System restoration tests
- Data integrity verification
- Performance benchmarking

---

## 9. Security Procedures

### 9.1 Access Control

**Role Management:**
```solidity
// Key roles in the system
bytes32 public constant EMERGENCY_ROLE = keccak256("EMERGENCY_ROLE");
bytes32 public constant MANAGER_ROLE = keccak256("MANAGER_ROLE");
bytes32 public constant WATCHDOG_OPERATOR_ROLE = keccak256("WATCHDOG_OPERATOR_ROLE");
```

**Role Assignments:**
- **EMERGENCY_ROLE**: Governance multisig only
- **MANAGER_ROLE**: Governance + designated managers
- **WATCHDOG_OPERATOR_ROLE**: Authorized watchdog operators

### 9.2 Security Monitoring

**Threat Detection:**
- Unusual operation patterns
- Coordinated challenge attempts
- Watchdog behavior anomalies
- Access control violations
- Performance degradation attacks

**Response Procedures:**
1. **Detect**: Automated monitoring alerts
2. **Assess**: Manual evaluation of threat
3. **Respond**: Implement appropriate countermeasures
4. **Recover**: Restore normal operations
5. **Review**: Post-incident analysis

### 9.3 Incident Response

**Severity Levels:**
- **Critical**: System compromise, data loss
- **High**: Security vulnerability, service disruption
- **Medium**: Performance impact, operational issues
- **Low**: Minor anomalies, informational events

**Response Teams:**
- **Security Team**: Threat assessment and response
- **Operations Team**: System maintenance and recovery
- **Governance Team**: Decision making and communications
- **Development Team**: Code fixes and improvements

### 9.4 Security Best Practices

**Operational Security:**
- Multi-signature requirements for critical operations
- Regular security audits and assessments
- Incident response plan maintenance
- Security awareness training

**Technical Security:**
- Reentrancy protection on all functions
- Input validation and sanitization
- Access control enforcement
- Event logging and monitoring

---

## 10. Troubleshooting Guide

### 10.1 Common Issues

**Operation Submission Failures:**
```
Problem: "NotPrimaryValidator()" error
Solution: Check primary validator selection algorithm
Verification: Ensure caller is designated primary validator
```

**Challenge Period Issues:**
```
Problem: "ChallengePeriodActive()" error
Solution: Wait for challenge period to expire
Verification: Check operation.finalizedAt timestamp
```

**Insufficient Consensus:**
```
Problem: "Insufficient approvals for disputed operation"
Solution: Obtain required approvals from watchdogs
Verification: Check approvalCount vs. required threshold
```

### 10.2 Diagnostic Commands

**Check Consensus State:**
```bash
npx hardhat console --network <network>
> const consensus = await ethers.getContract("OptimisticWatchdogConsensus")
> await consensus.getConsensusState()
```

**Check Operation Status:**
```bash
> const operation = await consensus.getOperation(operationId)
> console.log(operation)
```

**Check Active Watchdogs:**
```bash
> const watchdogs = await consensus.getActiveWatchdogs()
> console.log(watchdogs)
```

### 10.3 Error Resolution

**Configuration Errors:**
1. Verify contract addresses
2. Check role assignments
3. Validate service registrations
4. Confirm watchdog setup

**Operational Errors:**
1. Check system state
2. Verify operation parameters
3. Validate challenge periods
4. Review approval requirements

### 10.4 Performance Issues

**Slow Consensus:**
- Check network congestion
- Verify watchdog responsiveness
- Review challenge complexity
- Optimize operation parameters

**High Gas Costs:**
- Batch operations when possible
- Optimize contract interactions
- Review escalation patterns
- Consider parameter adjustments

---

## Appendices

### Appendix A: Event Reference

**Core Events:**
- `OperationSubmitted(operationId, operationType, primaryValidator, finalizeAt)`
- `OperationChallenged(operationId, challenger, objectionCount, newFinalizeAt)`
- `ConsensusEscalated(operationId, escalationLevel, requiredConsensus, additionalDelay)`
- `OperationExecuted(operationId, executor, success)`
- `OperationApproved(operationId, approver, totalApprovals)`
- `EmergencyOverride(operationId, overrider, reason)`

### Appendix B: Configuration Parameters

**Default Values:**
- Base challenge period: 3600 seconds (1 hour)
- Escalation delays: [3600, 14400, 43200, 86400] seconds
- Consensus thresholds: [0, 2, 3, 5] objections
- Minimum watchdogs: 3
- Maximum watchdogs: 20

### Appendix C: Security Considerations

**Key Security Features:**
- MEV-resistant validator selection
- Reentrancy protection
- Access control enforcement
- Event logging and monitoring
- Emergency override capabilities

### Appendix D: Contact Information

**Emergency Contacts:**
- Security Team: security@tbtc.network
- Operations Team: ops@tbtc.network
- Governance Team: governance@tbtc.network
- Development Team: dev@tbtc.network

**Communication Channels:**
- Discord: #tbtc-watchdog-ops
- Telegram: @tbtc_ops
- Email: watchdog-ops@tbtc.network

---

**Document Control:**
- Version: 1.0
- Last Updated: 2025-07-15
- Next Review: 2025-08-15
- Owner: tBTC Operations Team
- Approval: tBTC Governance