# V1.1 Interface Design - Complete

**Date**: 2025-07-15  
**Status**: Phase 1 Interface Design Complete âœ…  
**Branch**: `feat/account-control-v1_1`

## Interfaces Created

### 1. IOptimisticWatchdogConsensus.sol
**Purpose**: Core consensus mechanism interface  
**Key Features**:
- Optimistic operation submission
- Challenge and escalation mechanisms
- Emergency override capabilities
- Watchdog management functions

**Key Data Structures**:
```solidity
struct WatchdogOperation {
    bytes32 operationType;
    bytes operationData;
    address primaryValidator;
    uint64 submittedAt;
    uint64 finalizedAt;
    uint8 objectionCount;
    bool executed;
    bool challenged;
}
```

**Operation Types Defined**:
- RESERVE_ATTESTATION
- WALLET_REGISTRATION
- STATUS_CHANGE
- REDEMPTION_FULFILLMENT

### 2. IWatchdogOperation.sol
**Purpose**: Operation execution and encoding/decoding logic  
**Key Features**:
- Execute functions for each operation type
- Encoding functions for operation data
- Decoding functions for operation data
- Type-safe parameter handling

**Operations Supported**:
- Reserve attestation
- Wallet registration with SPV
- QC status changes
- Redemption fulfillment/default

### 3. IWatchdogRegistry.sol
**Purpose**: Watchdog registration and performance tracking  
**Key Features**:
- Watchdog registration by jurisdiction
- Performance score tracking
- T token stake management (optional)
- Weighted selection algorithms

**Key Data Structures**:
```solidity
struct WatchdogInfo {
    address watchdogAddress;
    bool isActive;
    uint64 registeredAt;
    uint64 lastActiveAt;
    string jurisdiction;
    uint256 performanceScore;
    uint256 totalOperations;
    uint256 successfulOps;
    uint256 challengesRaised;
    uint256 challengesWon;
}
```

## Design Decisions

### 1. Optimistic Execution Model
- Primary validator submits operations optimistically
- Base challenge period: Configurable (default 1 hour)
- Any active watchdog can challenge
- Escalating delays based on objection count

### 2. Error Handling
- Custom errors for gas efficiency
- Descriptive error names
- Comprehensive validation coverage

### 3. Event Design
- All events include indexed parameters for efficient filtering
- Consistent naming pattern: Operation[Action]
- Complete audit trail capability

### 4. Modularity
- Clean separation of concerns
- Operation logic separate from consensus
- Registry optional but recommended

## Gas Optimization Considerations

1. **Struct Packing**: 
   - Used uint64 for timestamps (sufficient until year 292471210647)
   - Used uint8 for counts (max 255 watchdogs)
   - Packed structs to minimize storage slots

2. **Function Visibility**:
   - External for all public functions
   - View/Pure modifiers properly applied

3. **Event Efficiency**:
   - Indexed parameters for common queries
   - Non-indexed for data that's rarely filtered

## Integration Points

### With Existing System:
1. **ProtocolRegistry**: Service registration for new contracts
2. **QCManager**: Operation execution target
3. **QCReserveLedger**: Attestation execution
4. **QCRedeemer**: Redemption handling

### New Components Needed:
1. **OptimisticWatchdogConsensus**: Main implementation
2. **WatchdogAdapter**: Backward compatibility
3. **WatchdogOperationLib**: Encoding/decoding library

## Next Steps

### Phase 2: Core Implementation (Next)
1. Implement OptimisticWatchdogConsensus contract
2. Create WatchdogOperationLib for encoding/decoding
3. Build WatchdogAdapter for compatibility
4. Initial unit tests

### Validation Checklist
- [x] All operation types covered
- [x] Error conditions defined
- [x] Events for monitoring
- [x] Gas optimization considered
- [x] Backward compatibility planned
- [x] Security considerations included

## Notes

- Interfaces follow Solidity 0.8.17 standards
- Compatible with existing SingleWatchdog patterns
- Ready for implementation phase
- No breaking changes to existing contracts